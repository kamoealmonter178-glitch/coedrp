name: Deep Breath (Hybrid Controller)

on:
  workflow_dispatch:

jobs:
  keep-alive-controller:
    runs-on: ubuntu-latest
    timeout-minutes: 360 # Run for 6 Hours Max
    env:
      GH_TOKEN: ${{ secrets.GH_TOKEN }} # MASTER TOKEN REQUIRED
      REPO_NAME: ${{ github.repository }}
      CODESPACE_NAME: "hybrid-worker-${{ github.run_id }}"

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: 1. Create/Start Hybrid Codespace
        run: |
          echo "üöÄ Sending Life Signal to GitHub Codespaces..."
          
          # Check if we already have one running (optional cleanup)
          # gh codespace delete --all --force --confirm || true

          # Create New Codespace from current branch
          echo "üå± Spawning 4-Core Linux Worker..."
          gh codespace create --repo $REPO_NAME --branch main --machine standardLinux32gb --display-name "$CODESPACE_NAME" --devcontainer-path .devcontainer/devcontainer.json
          
          # Wait for it to define itself
          sleep 60

      - name: 2. The Heartbeat Loop (6 Hours)
        run: |
          echo "‚ù§Ô∏è Entering Deep Breath Mode (Keep-Alive)..."
          
          # We need to find the exact name generated if we didn't force a specific name well enough, 
          # but usually 'gh codespace create' makes one. Let's list and pick the latest.
          CS_NAME=$(gh codespace list --repo $REPO_NAME --json name --jq '.[0].name')
          
          if [ -z "$CS_NAME" ]; then
            echo "‚ùå Fatal: No Codespace found!"
            exit 1
          fi
          
          echo "‚úÖ Targeted Codespace: $CS_NAME"

          # Loop for ~5.5 hours (330 mins) to be safe within 6h job limit
          # 330 mins / 5 min sleep = 66 iterations
          for i in {1..66}
          do
            echo "üíì Heartbeat #$i: Touching system..."
            
            # Send a dummy command via SSH to reset idle timer
            # "date" or "touch" is enough.
            # We use 'gh codespace ssh' wrapper.
            gh codespace ssh --codespace $CS_NAME -- -o StrictHostKeyChecking=no "touch /tmp/keepalive_signal && date"
            
            echo "üò¥ Sleeping 5 minutes..."
            sleep 300
          done

          echo "üõë Mission Complete. Shutting down Codespace to save quota..."
          gh codespace delete --codespace $CS_NAME --force
