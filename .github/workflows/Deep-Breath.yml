name: Deep Breath (Advanced Maestro)

on:
  workflow_dispatch:

jobs:
  maestro-controller:
    runs-on: ubuntu-latest
    timeout-minutes: 360 # 6 Hours Max
    env:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}
      TS_KEY: ${{ secrets.TS_KEY }} # Optional: For Auto-Auth
      REPO_NAME: ${{ github.repository }}
      CODESPACE_NAME: "hybrid-worker-${{ github.run_id }}"

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: 1. Spawn High-Spec Codespace (Europe)
        run: |
          echo "ðŸš€ Initiating Hybrid Codespace Protocol..."
          echo "ðŸŒ Region: Europe West (WestEurope) | ðŸ§  Specs: 8-Core / 32GB (Forced by GitHub)"
          
          # Force Delete Old (Cleanup)
          # gh codespace delete --all --force --confirm || true

          # Create with specific Machine Type and Location
          gh codespace create --repo $REPO_NAME --branch main --machine standardLinux32gb --location WestEurope --display-name "$CODESPACE_NAME" --devcontainer-path .devcontainer/devcontainer.json
          
          echo "â³ Waiting for initialization (60s)..."
          sleep 60

      - name: 2. Install & Configure Tailscale (Maestro Mode)
        run: |
          echo "ðŸ”§ Installing Tailscale inside Codespace..."
          CS_NAME=$(gh codespace list --repo $REPO_NAME --json name --jq '.[0].name')
          
          # Install Command
          gh codespace ssh --codespace $CS_NAME -- -o StrictHostKeyChecking=no "curl -fsSL https://tailscale.com/install.sh | sh"
          
          # Auto-Auth Logic (If Key Exists)
          if [ -n "$TS_KEY" ]; then
              echo "ðŸ”‘ TS_KEY detected! Auto-Authenticating..."
              gh codespace ssh --codespace $CS_NAME -- -o StrictHostKeyChecking=no "sudo tailscale up --authkey $TS_KEY --hostname $CODESPACE_NAME --ssh"
              
              # Get IP
              TS_IP=$(gh codespace ssh --codespace $CS_NAME -- -o StrictHostKeyChecking=no "tailscale ip -4")
              echo "TS_IP=$TS_IP" >> $GITHUB_ENV
          else
              echo "âš ï¸ No TS_KEY found. Manual Login required via VNC."
              echo "TS_IP=Not-Connected" >> $GITHUB_ENV
          fi

      - name: 3. Display Connection Info (RDP Style)
        run: |
          echo ""
          echo "=========================================="
          echo "   HYBRID CODESPACE READY (EUROPE)       "
          echo "=========================================="
          echo "1. VNC Desktop:  Port 6080 (via Browser)"
          echo "2. Tailscale IP: ${{ env.TS_IP }}"
          echo "3. Password:     vscode (if asked)"
          echo "------------------------------------------"
          echo "ðŸ¤– Run #2026 - Powered by DeepMind Agent"
          echo "=========================================="
          echo ""

      - name: 4. The Heartbeat Loop (6 Hours)
        run: |
          echo "â¤ï¸ Entering Deep Breath Mode (Keep-Alive)..."
          CS_NAME=$(gh codespace list --repo $REPO_NAME --json name --jq '.[0].name')

          # Loop 330 times (x 65s ~= 6 hours)
          for i in {1..330}
          do
            # Send 'date' command to reset timeout
            gh codespace ssh --codespace $CS_NAME -- -o StrictHostKeyChecking=no "date" >/dev/null 2>&1
            
            # Formatting log nicely
            if (( $i % 10 == 0 )); then
               echo "ðŸ’“ [$(date +%H:%M)] Heartbeat #$i: Pulse sent."
            fi
            
            sleep 60
          done

          echo "ðŸ›‘ Mission Complete. Shutting down..."
          gh codespace delete --codespace $CS_NAME --force
