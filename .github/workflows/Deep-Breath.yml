name: Deep Breath (Advanced Maestro)

on:
  workflow_dispatch:

jobs:
  maestro-controller:
    runs-on: ubuntu-latest
    timeout-minutes: 360 # 6 Hours Max
    env:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}
      TS_KEY: ${{ secrets.TS_KEY }} # Optional: For Auto-Auth
      REPO_NAME: ${{ github.repository }}
      CODESPACE_NAME: "hybrid-worker-${{ github.run_id }}"

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: 1. Spawn High-Spec Codespace (Europe)
        run: |
          echo "ðŸš€ Initiating Hybrid Codespace Protocol..."
          echo "ðŸŒ Region: Europe West (WestEurope) | ðŸ§  Specs: 8-Core / 32GB (Forced by GitHub)"
          
          # Force Delete Old (Cleanup)
          # gh codespace delete --all --force --confirm || true

          # Create with specific Machine Type and Location
          gh codespace create --repo $REPO_NAME --branch main --machine standardLinux32gb --location WestEurope --display-name "$CODESPACE_NAME" --devcontainer-path .devcontainer/devcontainer.json
          
          echo "â³ Waiting for initialization (100s)..."
          sleep 100

      - name: 2. Install & Configure Tailscale (Maestro Mode)
        run: |
          echo "ðŸ”§ Installing Tailscale inside Codespace..."
          CS_NAME=$(gh codespace list --repo $REPO_NAME --json name --jq '.[0].name')
          
          # --- SSH READY CHECK LOOP ---
          echo "ðŸ“ž Checking SSH connectivity..."
          for i in {1..30}; do
             if gh codespace ssh --codespace $CS_NAME -- -o StrictHostKeyChecking=no "echo Ready"; then
                echo "âœ… SSH is Live!"
                break
             fi
             echo "zzz... Waiting for SSH ($i/30)..."
             sleep 10
          done
          # -----------------------------

          # FIX: Clean Apt Cache to prevent 'amd64 vs i386' error
          echo "ðŸ§¹ Cleaning Apt Cache..."
          gh codespace ssh --codespace $CS_NAME -- -o StrictHostKeyChecking=no "sudo rm -rf /var/lib/apt/lists/* && sudo apt-get clean && sudo apt-get update"

          # Install Command
          gh codespace ssh --codespace $CS_NAME -- -o StrictHostKeyChecking=no "curl -fsSL https://tailscale.com/install.sh | sh"
          
          # Auto-Auth OR Link Mode
          if [ -n "$TS_KEY" ]; then
              echo "ðŸ”‘ TS_KEY detected! Attempting Auto-Auth..."
              if gh codespace ssh --codespace $CS_NAME -- -o StrictHostKeyChecking=no "sudo tailscale up --authkey $TS_KEY --hostname $CODESPACE_NAME --ssh --timeout=10s"; then
                 echo "âœ… Tailscale Connected via Key."
                 TS_IP=$(gh codespace ssh --codespace $CS_NAME -- -o StrictHostKeyChecking=no "tailscale ip -4")
                 echo "TS_IP=$TS_IP" >> $GITHUB_ENV
              else
                 echo "âš ï¸ Key Auth failed. Switching to Link Mode."
                 # Fallback to Link Mode logic below if desired, but for now we warn.
              fi
          fi
          
          # If still not connected (No Key or Failed), generate Auth Link
          # We run 'up' in background or check status? 
          # Interactive 'up' via SSH is hard to capture. 
          # We assume user might use VNC if Key fails, as requested "Link not API" usually implies manual.
          if [ -z "$TS_IP" ]; then
             echo "âš ï¸ Tailscale not fully engaged. Please use VNC -> Terminal -> 'sudo tailscale up' to authenticate manually."
             echo "TS_IP=Connect-via-VNC-First" >> $GITHUB_ENV
          fi

      - name: 3. Display Connection Info (RDP Style)
        run: |
          echo ""
          echo "=========================================="
          echo "   HYBRID CODESPACE READY (EUROPE)       "
          echo "=========================================="
          echo "1. VNC Desktop:  Port 6080 (via Browser)"
          echo "2. Tailscale IP: ${{ env.TS_IP }}"
          echo "3. Password:     vscode (if asked)"
          echo "------------------------------------------"
          echo "ðŸ¤– Run #2026 - Powered by DeepMind Agent"
          echo "=========================================="
          echo ""

      - name: 4. The Heartbeat Loop (6 Hours)
        run: |
          echo "â¤ï¸ Entering Deep Breath Mode (Keep-Alive)..."
          CS_NAME=$(gh codespace list --repo $REPO_NAME --json name --jq '.[0].name')

          # Loop 330 times (x 65s ~= 6 hours)
          for i in {1..330}
          do
            # Send 'date' command to reset timeout
            gh codespace ssh --codespace $CS_NAME -- -o StrictHostKeyChecking=no "date" >/dev/null 2>&1
            
            # Formatting log nicely
            if (( $i % 10 == 0 )); then
               echo "ðŸ’“ [$(date +%H:%M)] Heartbeat #$i: Pulse sent."
            fi
            
            sleep 60
          done

          echo "ðŸ›‘ Mission Complete. Shutting down..."
          gh codespace delete --codespace $CS_NAME --force
